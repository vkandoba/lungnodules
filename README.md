# Тестовое задание. Поиск узлов на КТ легких

## Задача и сценарий использования
Обнаружить узлы в легких по результатам КТ-исследования. Выбрать, обучить и протестировать модель. 

Переформулировал задачу, чтобы упростить предварительную обработку, построение выборки и ускорить обучение нейронной сети.

Упрощенная задача - на снимках из конкретной плоскости, про которые известно, что есть патология, выделить узлы. Сводится к построению модели, сегментирующей 2D-изображения.

Предполагаемый сценарий использования:
1. Предварительный классификатор отбирает снимки, которые вызывают подозрение
2. Модель выделяет области, в которых вероятно обнаружение узлов

На практике, как правило, используют обратный подход - готовят модель, определяющую патологии на области небольшого размера. Применяют её к отдельным частям изображения и по результатам его классифицируют. 

## Исходные данные

1. Протоколы исследования в формате json с описанием найденных узлов - координаты, диаметр и заключение специалиста
2. Результаты КТ в виде серии поперечных снимков, сохраненных в формате dicom. Отдельно с выделением области легких и окружающих тканей.

**Особенности протоколов:**
* Есть позиции с одним id узла, которые находятся далеко друг от друга
* Часто позиции c разными id описывают один узел - имеют очень близкие центр и диаметр

*При финальной оценке качества разные позиции интерпретировал как разные узлы, даже если они пересекаются*

## Данные для обучения

Предполагал, что снимки КТ делают в одном направлении. Нормализовал z-координаты и выбрал небольшой диапазон, в котором достаточно много снимков с узлами.

*Важно, чтобы снимки из одного исследования не присутствовали в разных выборках*

Разбил исследования на выборки для обучения (train), валидации (valid) и финальной оценки (test). 

**Принципы:**
* (train/valid) / test - по порядку (метка времени есть для всех исследований), тк в приложении будем использовать модель на основе прошедших исследований в последующих
* train / valid - с сохранением распределения по кол-ву узлов, которые необходимо обнаружить
 
 ## Модель
 
 Использовал нейронную сеть семейства U-Net - такие часто применяют для классификации медицинских изображений. Базовый encoder - resnet50.
 
 Предобработка - нормализация и перевод в RGB, т.к входной слой 'из коробки' определен для цветных изображений.
 
 Оптимизируемая функция потерь - коэффициент Жаккара, метрики - IoU, точность и полнота в геометрическом смысле - подсчитанные на основе площади.
 
 Результат применения сети к снимку - карта вероятностей того, что конкретная точки принадлежит области узла. Модель сегментации - применение заданного порога (threshold) к карте вероятностей.
 
 ## Результат и итоговые оценки

 Оценил модель на test с точки зрения обнаруженных узлов
 * **Искомый узел** - точки, выделенные на основе каждой позиции протокола из этой плоскости
 * **Предполагаемый узел** - каждая связанная область из результата модели, независимо от площади

* **TP** - узел обнаружен правильно - предполагаемый пересекается с искомым
* **FP** - узел обнаружен неправильно - предполагаемый не пересекается ни с одном искомым
* **FN** - узел не обнаружен - с искомым не пересекается ни один предполагаемый

|Threshold	| TP	| FP	| FN	| Precision	| Recall	| IoU		| Precision by Square	| Recall by Square |
|-----------|-------|-------|-------|-----------|-----------|-----------|---------------|------------|
|	0.50	| 29	| 806	| 12	| 0.034731	| 0.707317	| 0.005586	| 0.005628		| 0.728870   |
|	0.55	| 29	| 749	| 12	| 0.037275	| 0.707317	| 0.005806	| 0.005856		| 0.712488   |
|	0.60	| 28	| 718	| 13	| 0.037534	| 0.682927	| 0.006119	| 0.006178		| 0.699327   |
|	0.65	| 27	| 704	| 14	| 0.036936	| 0.658537	| 0.006418	| 0.006488		| 0.685373   |
|	0.70	| 26	| 670	| 15	| 0.037356	| 0.634146	| 0.006803	| 0.006884		| 0.667118   |
|	0.75	| 25	| 630	| 16	| 0.038168	| 0.609756	| 0.007341	| 0.007443		| 0.658332   |
|	0.80	| 24	| 618	| 17	| 0.037383	| 0.585366	| 0.007916	| 0.008042		| 0.644359   |
|	0.85	| 24	| 577	| 17	| 0.039933	| 0.585366	| 0.008723	| 0.008891		| 0.627355   |
|	0.90	| 23	| 535	| 18	| 0.041219	| 0.560976	| 0.010365	| 0.010641		| 0.607034   |
|	0.95	| 20	| 422	| 21	| 0.045249	| 0.487805	| 0.015284	| 0.044161		| 0.560623   |

 Выбрал threshold 0.95 с т.з. оптимизации IoU. В такой модели теряется покрытие, но обнаруженные узлы по размерам ближе всего к искомым.

### Confusion matrix

|        | Predicted 1 | Predicted 0|
|------- | ----------- | -----------|
|Actual 1| 20          | 21         |
|Actual 0| 422         |            |


### Точность и полнота
* **Precision** - 0.045
* **Recall** - 0.488
