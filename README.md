# Тестовое задание. Поиск узлов на КТ легких

## Задача и сценарий использования
Обнаружить узлы в легких по результатам КТ-исследования. Выбрать, обучить и протестировать модель. 

Переформулировал задачу, чтобы упростить предварительную обработку, построение выборки и ускорить обучение нейронной сети.

Упрощенная задача - на снимках из конкретной плоскости, про которые известно, что есть патология, выделить узлы. Сводится к построению модели, сегментирующей 2D-изображения.

Предполагаемый сценарий использования:
1. Предварительный классификатор отбирает снимки, которые вызывают подозрение
2. Модель выделяет области, в которых вероятно обнаружение узлов

На практике, как правило, используют обратный подход - готовят модель, определяющую патологии на области небольшого размера. Применяют её к отдельным частям изображения и по результатам его классифицируют. 

## Исходные данные

1. Протоколы исследования в формате json с описанием найденных узлов - координаты, диаметр и заключение специалиста
2. Результаты КТ в виде серии поперечных снимков, сохраненных в формате dicom. Отдельно с выделением области легких и окружающих тканей.

**Особенности протоколов:**
* Есть позиции с одним id узла, которые находятся далеко друг от друга
* Часто позиции c разными id описывают один узел - имеют очень близкие центр и диаметр

*При финальной оценке качества разные позиции интерпиртировал как разные узлы, даже если они пересекаются*

## Данные для обучения

Преполагал, что снимки КТ делают в одном направлении. Нормализовал z-координаты и выбрал небольшой диапазон, в котором достаточно много снимков с узлами.

*Важно, чтобы снимки из одного исследования не присутсвовали в разных выборках*

Разбил исследования на выборки для обучения (train), валидации (valid) и финальной оценки (test). 

**Принципы:**
* (train/valid) / test - по времени, тк в приложении будем использовать модель на основе прошедших исследований в последующих 
* train / valid - с сохранением распределения по кол-ву узлов, которые необходимо обнаружить
 
 ## Модель
 
 Использовал нейронную сеть семейства U-Net - такие часто применяют для классификации медицинских изображений. Базовый encoder - resnet50.
 
 Предобработка - нормализация и перевод в RGB, т.к входной слой 'из коробки' определен для цветных изображений.
 
 Оптимизируемая функция потерь - коэффицент Жаккара, метрики - IoU, точность и полнота в геометрическом смысле - посчитанные на основе площади.
 
 Результат применения сети к снимку - карта вероятностей того, что конкретная точки принадлежит области узла. Модель сегментации - применение заданного порога (threshold) к карте вероятностей.
 
 ## Результат и итоговые оценки
 
 Выбрал threshold и оценил модель на test с точки зрения обнаруженных узлов
 * **Искомый узел** - точки, выделенные на основе каждой позиции протокола из этой плостости
 * **Предполагаемый узел** - каждая связанная область из результата модели, независимо от площади
 
 
 Рассчитал точность, полноту, TP, FP, FN
